"use strict";define("composer/uploads",["composer/preview","composer/categoryList","translator","alerts","uploadHelpers","jquery-form"],function(e,t,r,a,i){var o={inProgress:{}};var s="";o.initialize=function(e){l(e);f(e);n(e);u(e);r.translate("[[modules:composer.uploading, "+0+"%]]",function(e){s=e})};function n(e){var t=$('.composer[data-uuid="'+e+'"]');t.find("#files").on("change",function(t){var r=(t.target||{}).files||($(this).val()?[{name:$(this).val(),type:utils.fileMimeType($(this).val())}]:null);if(r){m({files:r,post_uuid:e,route:"/api/post/upload"})}})}function u(e){var t=$('.composer[data-uuid="'+e+'"]');t.on("click",".topic-thumb-clear-btn",function(e){t.find("input#topic-thumb-url").val("").trigger("change");p(t.find("input#topic-thumb-file"));$(this).addClass("hide");e.preventDefault()});t.on("paste change keypress","input#topic-thumb-url",function(){var e=$(this);setTimeout(function(){var r=e.val();if(r){t.find(".topic-thumb-clear-btn").removeClass("hide")}else{p(t.find("input#topic-thumb-file"));t.find(".topic-thumb-clear-btn").addClass("hide")}t.find("img.topic-thumb-preview").attr("src",r)},100)})}function p(e){e.wrap("<form />").closest("form").get(0).reset();e.unwrap()}function l(e){var t=$('.composer[data-uuid="'+e+'"]');i.handleDragDrop({container:t,callback:function(t){m({files:t.files,post_uuid:e,route:"/api/post/upload",formData:t.formData})}})}function f(e){var t=$('.composer[data-uuid="'+e+'"]');i.handlePaste({container:t,callback:function(t){m({files:t.files,fileNames:t.fileNames,post_uuid:e,route:"/api/post/upload",formData:t.formData})}})}function c(e){return e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}function d(e,t,r){return e.slice(0,t)+r+e.slice(t)}function m(i){var n=[...i.files];var u=i.post_uuid;var p=$('.composer[data-uuid="'+u+'"]');var l=p.find("textarea");var f=l.val();var m=p.find("#fileForm");var v=false;m.attr("action",config.relative_path+i.route);var h=t.getSelectedCid();if(!h&&ajaxify.data.cid){h=ajaxify.data.cid}var b=0;var _=false;for(b=0;b<n.length;++b){_=n[b].type.match(/image./);if(_&&!app.user.privileges["upload:post:image"]||!_&&!app.user.privileges["upload:post:file"]){return a.error("[[error:no-privileges]]")}}var w=[];for(b=0;b<n.length;++b){w.push(b+"_"+Date.now()+"_"+(i.fileNames?i.fileNames[b]:n[b].name));_=n[b].type.match(/image./);if(n[b].size>parseInt(config.maximumFileSize,10)*1024){m[0].reset();return a.error("[[error:file-too-big, "+config.maximumFileSize+"]]")}f=d(f,l.getCursorPosition(),(_?"!":"")+"["+w[b]+"]("+s+") ")}if(m.length){p.find('[data-action="post"]').prop("disabled",true)}l.val(f);$(window).trigger("action:composer.uploadStart",{post_uuid:u,files:w.map(function(e,t){return{filename:e.replace(/^\d+_\d{13}_/,""),isImage:/image./.test(n[t].type)}}),text:s});m.off("submit").submit(function(){function t(e,t,r){var a;if(r){a=e.replace(/^\d+_\d{13}_/,"")}var i=l.val();var o=new RegExp(c(e)+"]\\([^)]+\\)","g");l.val(i.replace(o,(a||e)+"]("+t+")"));$(window).trigger("action:composer.uploadUpdate",{post_uuid:u,filename:e,text:t})}o.inProgress[u]=o.inProgress[u]||[];o.inProgress[u].push(1);if(i.formData){i.formData.append("cid",h)}$(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},resetForm:true,clearForm:true,formData:i.formData,data:{cid:h},error:function(r){v=true;p.find('[data-action="post"]').prop("disabled",false);const a=g(r,u);for(var i=0;i<n.length;++i){t(w[i],a,true)}e.render(p)},uploadProgress:function(e,a,i,o){r.translate("[[modules:composer.uploading, "+o+"%]]",function(e){if(v){return}for(var r=0;r<n.length;++r){t(w[r],e)}})},success:function(r){const a=r.response.images;v=true;if(a&&a.length){for(var i=0;i<a.length;++i){a[i].filename=w[i].replace(/^\d+_\d{13}_/,"");a[i].isImage=/image./.test(n[i].type);t(w[i],a[i].url,true)}}e.render(p);l.focus();p.find('[data-action="post"]').prop("disabled",false);$(window).trigger("action:composer.upload",{post_uuid:u,files:a})},complete:function(){m[0].reset();o.inProgress[u].pop()}});return false});m.submit()}function g(e,t){var r=e.responseJSON&&(e.responseJSON.error||e.responseJSON.status&&e.responseJSON.status.message)||"[[error:parse-error]]";if(e&&e.status===413){r=e.statusText||"Request Entity Too Large"}a.error(r);$(window).trigger("action:composer.uploadError",{post_uuid:t,message:r});return r}return o});
//# sourceMappingURL=uploads.js.map
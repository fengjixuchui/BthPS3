"use strict";define("topicThumbs",["api","bootbox","alerts","uploader","benchpress","translator","jquery-ui/widgets/sortable"],function(t,e,o,a,l,d){const s={};s.get=(e=>t.get(`/topics/${e}/thumbs`,{}));s.getByPid=(e=>t.get(`/posts/${e}`,{}).then(t=>s.get(t.tid)));s.delete=((e,o)=>t.del(`/topics/${e}/thumbs`,{path:o}));s.deleteAll=(t=>{s.get(t).then(e=>{Promise.all(e.map(e=>s.delete(t,e.url)))})});s.upload=(t=>new Promise(e=>{a.show({title:"[[topic:composer.thumb_title]]",method:"put",route:config.relative_path+`/api/v3/topics/${t}/thumbs`},function(t){e(t)})}));s.modal={};s.modal.open=function(t){const{id:o,pid:a}=t;let{modal:r}=t;let n;return new Promise(m=>{Promise.all([s.get(o),a?s.getByPid(a):[]]).then(t=>new Promise(e=>{const o=t.reduce((t,e)=>t.concat(e));n=o.length;e(o)})).then(t=>l.render("modals/topic-thumbs",{thumbs:t})).then(a=>{if(r){d.translate(a,function(t){r.find(".bootbox-body").html(t);s.modal.handleSort({modal:r,numThumbs:n})})}else{r=e.dialog({title:"[[modules:thumbs.modal.title]]",message:a,buttons:{add:{label:'<i class="fa fa-plus"></i> [[modules:thumbs.modal.add]]',className:"btn-success",callback:()=>{s.upload(o).then(()=>{s.modal.open({...t,modal:r});require(["composer"],t=>{t.updateThumbCount(o,$(`[component="composer"][data-uuid="${o}"]`));m()})});return false}},close:{label:"[[global:close]]",className:"btn-primary"}}});s.modal.handleDelete({...t,modal:r});s.modal.handleSort({modal:r,numThumbs:n})}})})};s.modal.handleDelete=(a=>{const l=a.modal.get(0);l.addEventListener("click",l=>{if(l.target.closest('button[data-action="remove"]')){e.confirm("[[modules:thumbs.modal.confirm-remove]]",e=>{if(!e){return}const d=l.target.closest(".media[data-id]").getAttribute("data-id");const r=l.target.closest(".media[data-path]").getAttribute("data-path");t.del(`/topics/${d}/thumbs`,{path:r}).then(()=>{s.modal.open(a)}).catch(o.error)})}})});s.modal.handleSort=(({modal:t,numThumbs:e})=>{if(e>1){const e=t.find(".topic-thumbs-modal");e.sortable({items:"[data-id]"});e.on("sortupdate",s.modal.handleSortChange)}});s.modal.handleSortChange=((e,a)=>{const l=a.item.get(0).parentNode.querySelectorAll("[data-id]");Array.from(l).forEach((e,a)=>{const l=e.getAttribute("data-id");let d=e.getAttribute("data-path");d=d.replace(new RegExp(`^${config.upload_url}`),"");t.put(`/topics/${l}/thumbs/order`,{path:d,order:a}).catch(o.error)})});return s});
//# sourceMappingURL=topicThumbs.js.map